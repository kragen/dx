<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://www.facebook.com/2008/fbml">
<head><title>Search My Stuff on Facebook</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style>
textarea { display: block }
.devtools { display: none }
.searchline { padding: 2em; }
.show_only_when_posts_exist, .show_only_when_logged_in { display: none } /* by default */
.login {
    display: inline-block;
    text-align: center;
    font-size: 26px;
    background-color: #eee;
    border: .5em outset;
    border-radius: 6px;
    -moz-border-radius: 6px;
    -webkit-border-radius: 6px;
    padding: 1em;
}
.logincontainer { margin-bottom: 11px }
</style>

<style>
/* from Facebook */
body {
color:#333333;
direction:ltr;
font-family:"lucida grande",tahoma,verdana,arial,sans-serif;
font-size:11px;
text-align:left;
}
.uiStreamMessage, .link_top {
font-size:13px;
font-weight:normal;
margin: 0.5em 0 5px 0;
clear: left;
}
.uiStreamMessage, .uiAttachmentTitle, .uiAttachmentDesc {
word-wrap:break-word;
}
h1, h2, h3, h4, h5, h6 {
color:#333333;
margin:0;
padding:0;
}
h1 {
    font-size: 26px;
}
h2, h3, h4, h5, h6 {
    font-size:13px;
}
.actorName, .uiStreamMessage .passiveName {
font-weight:bold;
}
a {
color:#3B5998;
cursor:pointer;
outline-style:none;
text-decoration:none;
}
abbr {
border-bottom:medium none;
}
uiAttachmentDesc, .uiStreamPassive, .uiStreamSource, .uiStreamSource a {
color:#808080;
}
a {
color:#3B5998;
cursor:pointer;
text-decoration:none;
}
.uiStreamSource {
display: block;
margin-top: -0.25em;
margin-bottom: 0.50em;
  clear: left;
}
.error {
color: red;
margin: 1em;
font-size: 15px;
}

.link_top_inside {
    font-size: 13px;
    font-weight: normal;
}
.UIStoryAttachment {
    margin: 6px 0 5px;
}
.UIStoryAttachment_Media {
    float: left;
    padding-right: 10px;
}
.UIStoryAttachment_Media img {
    max-width: 130px;
    max-height: 130px;
}
.UIStoryAttachment_Title {
    font-weight: bold;
}
.UIStoryAttachment_Caption, .UIStoryAttachment_Copy {
    color: #808080;
    padding-top: 3px;
}
img {
    border: 0 none;
}
</style>

</head> <body>

<div style="text-align: center;">
<h1>Search My Stuff on Facebook</h1>
<p>
<span class="show_only_when_no_posts_exist">Click the button below to grab</span
><span class="show_only_when_posts_exist">This app grabs</span
> all the stuff you've ever posted on
Facebook. It's just all of your past Facebook status messages and shared
links so far. It will download a backup copy of your Stuff 
(this usually takes less than five seconds)
and let you
Search it too. The backup copy will be stored on your computer in your
browser until you delete it.
</p>
<p>
None of this data ever gets sent to our server; it's all direct
communication between your browser and Facebook.
</p>
<div class="logincontainer show_only_when_no_posts_exist">
<a class="login"
   href="javascript:FB.Connect.requireSession(retrieve_everything)">
     <img src="http://knx.to/i/trefoil_8bit.png" style="vertical-align: middle;" />
     Get My Stuff!
</a>
</div>
<div class="searchline show_only_when_posts_exist">
  Search: <input class="search" size="64" />
</div>
<div>
<span class="show_only_when_logged_in">
<a href="javascript:FB.Connect.logoutAndRedirect(location.href);">log out</a>
</span>
<span class="show_only_when_posts_exist">
<span class="show_only_when_logged_in"
>|</span>
<a href="javascript:FB.Connect.requireSession(retrieve_everything)">update this backup copy</a>
| <a href="javascript:export_storage()">json export in popup</a>
| <a href="javascript:reset_storage()">delete the backup copy stored in this browser</a>
</span>
<span>
<span class="show_only_when_no_posts_exist"><span class="show_only_when_logged_in"
>|</span></span><span class="show_only_when_posts_exist"
>|</span>
<a href="#" onclick="$('.devtools').toggle();$('.devtoolsshow').toggle(); return false"
><span class="devtoolsshow">show</span
><span class="devtools">hide</span
> dev tools</a></span>
</div>
</div>

<div class="devtools">
<a href="javascript:login()">log in to FB!</a>
| <a href="javascript:FB.Connect.requireSession(retrieve_status)">retrieve status messages</a>
| <a href="javascript:FB.Connect.requireSession(retrieve_link)">retrieve links</a>
| <a href="javascript:display_posts()">display status messages</a>
  <textarea id="FQL" rows=3 cols=80>SELECT time, message, status_id from status where uid=1173721181</textarea>
  <button onclick="do_query()">run query Â»</button>
  <textarea id="output" rows=20 cols=80></textarea>
</div>
<p>
<hr />
<div class="posts"></div>
<div class="fql_link"></div>

<script src="http://static.ak.connect.facebook.com/js/api_lib/v0.4/FeatureLoader.js.php/en_US" type="text/javascript"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.js"></script>
<script src="json2.js"></script>
<script src="local_storage.js"></script>
<script src="karnak.js"></script>
<script src="channel.js"></script>
<script type="text/javascript">


/* developer tools */

function login() {
  FB.ensureInit( function () {
    FB.Connect.requireSession(function () { 
      output("got a session");
    }, false);
  });
}

function do_query() {
    var o = $('#output');
    var q = $('#FQL').val();
    o.val(o.val() + "\n>>> " + q);
    FB.Facebook.apiClient.fql_query(q, output);
}

function output(response) {
    $('#output').val($('#output').val() + "\n" + JSON.stringify(response, undefined, 3));
    if (typeof console != 'undefined') console.log(response);
}


/* replication of FQL tables */

var replicas = {
  _channels: {}
  ,get: function(key) {
        var k = 'fql_' + key;

        if (window[k]) return window[k];

        var string = get_local_storage().get(k);
        if (string) {
            window[k] = JSON.parse(string);
            return window[k];
        }

        return undefined;
    }

  ,set: function(key, value) {
        var k = 'fql_' + key;

        window[k] = value;

        get_local_storage().set(k, JSON.stringify(value, undefined, 3));
        output(['stored', k, value.length]);

        this.channel(key).changed();
    }

  ,remove: function(key) {
        var k = 'fql_' + key;

        output(['deleting', k]);
        get_local_storage().remove(k);
        output(['gone from local storage', k]);

        window[k] = undefined;  // Can't use `delete`, because in IE, "Object does not support this action"
        output(['gone from window', k]);

        this.channel(key).changed();
        output(['notified of change', k]);
    }

  ,channel: function(key) {
        if (!(key in this._channels)) this._channels[key] = new Channel();
        return this._channels[key];
    }
};


/* stuff related to posts in the abstract */

function query_match(query, string) {
    if (query === '') return true;
    if (string === null) return false;
    return -1 !== string.toLowerCase().indexOf(query);
}

function displayDate(unix_epoch) {
  var d = new Date(unix_epoch*1000);
  var t = new Date();
  var s = '';
  var age = t.getTime() - d.getTime();
  var age_d = Math.floor(age / (24*60*60*1000));
  var age_w = Math.floor(age / (7*24*60*60*1000));
  var age_y = t.getYear() - d.getYear();
  var age_m = t.getMonth() - d.getMonth() + 12 * age_y;
  if (age < 1000) {
        s += ("right now");
  } else if ((age >= 1000) && (age < 60*1000)) {
        s += (Math.floor(age/1000) + " second");
        if (age >= 2000) {s += ('s');}
        s += (' ago');
  } else if ((age >= 60*1000) && (age < 60*60*1000)) {
        s += (Math.floor(age/(60*1000)) + " minute");
        if (age >= 2*60*1000) {s += ('s');}
        s += (' ago');
  } else if ((age >= 60*60*1000) && (age < 24*60*60*1000)) {
        s += (Math.floor(age/(60*60*1000)) + " hour");
        if (age >= 2*60*60*1000) {s += ('s');}
        s += (' ago');
  } else if ((age >= 24*60*60*1000) && (age < 7*24*60*60*1000)) {
        s += ((age_d >= 2) ? age_d + " days ago" : "yesterday");
  } else if ((age >= 7*24*60*60*1000) && (age < 4*7*24*60*60*1000)) {
        s += ((age_w >= 2) ? age_w + " weeks ago" : "last week");
  } else if ((age >= 4*7*24*60*60*1000) && (age_y == 0)) {
        s += ((age_m >= 2) ? age_m + " months ago" : "last month");
  } else if (age_y > 0) {
        s += ((age_y >= 2) ? age_y + " years ago" : "last year");
  }
  return s;
}

function autolinkify(text) {
    return (''+text).replace(/http:\/\/[^\s<>"]*[^\s<>".,]/g,
                             '<a href="$&" target="_blank">$&</a>');
}

function autolinkify_var(v) {
    return {render:function(vars) { return autolinkify(htmlescape(vars[v])) }};
}                  

var relative_time_template = {render:function(vars){return displayDate(vars.time_t())}};
var time_template = {render:function(vars){return ''+new Date(1000*vars.time_t())}};

var you_link_template = {render: function() {
        var users = replicas.get('user') || [{name: 'You', uid: 'unknown'}];
        return '<a href="http://www.facebook.com/profile.php?id='+htmlescape(users[0].uid)+'" class="actorName">'+htmlescape(users[0].name)+'</a> ';
    }
};


/* status posts */

function retrieve_status() {
    var query = 'SELECT uid, time, message, status_id from status where uid=' + 
            FB.Connect.get_loggedInUser();
    FB.Facebook.apiClient.fql_query(query, store_status);
}

function store_status(new_status_messages) {
    if (!new_status_messages) return;
    replicas.set('status', new_status_messages);
}


var status_template = tmpl.as_template([
    '<h6 class="uiStreamMessage">',
    you_link_template,
    autolinkify_var('message'),
    '</h6>',
    '<span class="uiStreamSource">',
    '<a href="http://www.facebook.com/profile.php?id=',tmpl.v('uid'),'&amp;v=wall&amp;story_fbid=',tmpl.v('status_id'),'">',
    '<abbr title="',time_template,'" class="timestamp">',relative_time_template,'</abbr></a></span>'
]);

function FQL_Status(obj) {
    $.extend(this, obj);
}
FQL_Status.prototype.render = function() {
    return status_template.render(this);
};
FQL_Status.prototype.time_t = function() { return this.time };
FQL_Status.prototype.matches = function(string) {
    return query_match(string, this.message);
};


/* link posts */

function retrieve_link() {
    var query = 'select link_id,owner,owner_comment,created_time,title,summary,url,image_urls from link where owner = ' +
        FB.Connect.get_loggedInUser();
    FB.Facebook.apiClient.fql_query(query, store_link);
}

function store_link(response) {
    if (!response) return;
    replicas.set('link', response);
}

var link_image_template = {render: function(vars) {
        if (!vars.image_urls) return '';
        if (!vars.image_urls[0]) return '';
        return '<img src="'+htmlescape(vars.image_urls[0])+'" class="img"/>';
    }};

function url_domain_template(varname) {
    return {render: function(vars) {
            var url = vars[varname];
            return htmlescape(url); // XXX not done yet
        }};
}

var link_template = tmpl.as_template([
    '<div class="link_top">',
    '<h3 class="link_top_inside">',
    you_link_template,
    autolinkify_var('owner_comment'),
    '</h3>',
    '</div>',


    '<div class="UIStoryAttachment">',

    '<div class="UIStoryAttachment_Media UIStoryAttachment_MediaSingle">',
     '<div class="UIMediaItem">',
      '<a target="_blank" href="',tmpl.v('url'),'">',
       '<div class="UIMediaItem_Wrapper">',
        link_image_template,
       '</div>',
      '</a>',
     '</div>',
    '</div>',

    '<div class="UIStoryAttachment_Info">',
     '<div class="UIStoryAttachment_Title">',
      '<a href="',tmpl.v('url'),'">',tmpl.v('title'),'</a>',
     '</div>',
     '<div class="UIStoryAttachment_Caption">',url_domain_template('url'),'</div>',
     '<div class="UIStoryAttachment_Copy">',tmpl.v('summary'),'</div>',
    '</div>',

    '</div>',


    '<span class="uiStreamSource">',
    '<a href="http://www.facebook.com/profile.php?id=',tmpl.v('uid'),'&amp;v=wall&amp;story_fbid=',tmpl.v('link_id'),'">',
    '<abbr title="',time_template,'" class="timestamp">',relative_time_template,'</abbr></a></span>'
]);

function FQL_Link(obj) {
    $.extend(this, obj);
}
FQL_Link.prototype.render = function() {
    return link_template.render(this);
};
FQL_Link.prototype.time_t = function() { return this.created_time };
FQL_Link.prototype.matches = function(query) {
    return (query_match(query, this.owner_comment) ||
            query_match(query, this.title) ||
            query_match(query, this.summary) ||
            query_match(query, this.url));
};


/* user, i.e. myself */

function retrieve_user() {
    var query = 'select uid, username, name from user where uid = ' + 
        FB.Connect.get_loggedInUser();
    FB.Facebook.apiClient.fql_query(query, store_user);
}

function store_user(user) {
    if (!user) return;
    replicas.set('user', user);
}


/* misc. UI functionality */

function retrieve_everything() {
    retrieve_user();
    retrieve_status();
    retrieve_link();
}

function reset_storage () {
    replicas.remove('user');
    replicas.remove('status');
    replicas.remove('link');
}

function export_storage () {
    var g = {
      status: replicas.get('status')
      ,link: replicas.get('link')
      ,user: replicas.get('user')
    };

    var popup = window.open('#', '_blank');
    popup.document.open('text/plain');
    popup.document.write(JSON.stringify(g, undefined, 3));
    popup.document.close();
}


/* the collection of all posts */

var posts = [];
var posts_channel = new Channel();

function update_posts() {
    posts = [];

    var status = replicas.get('status') || [];
    for (var ii = 0; ii < status.length; ii++) {
        posts.push(new FQL_Status(status[ii]));
    }

    var link = replicas.get('link') || [];
    for (var ii = 0; ii < link.length; ii++) {
        posts.push(new FQL_Link(link[ii]));
    }

    posts.sort(function(a, b) {
            return b.time_t() - a.time_t();
    });
    posts_channel.changed();
}

replicas.channel('status').on_change(update_posts);
replicas.channel('link').on_change(update_posts);
replicas.channel('user').on_change(update_posts); // because it's used in some templates.

posts_channel.on_change(function() {
    if (posts.length) {
        $('.show_only_when_no_posts_exist').hide();
        $('.show_only_when_posts_exist').show();
    } else {
        $('.show_only_when_no_posts_exist').show();
        $('.show_only_when_posts_exist').hide();
    }
});

function display_posts() {
    var filter = $('.search').val();

    var html = [];
    for (var ii = 0; ii < posts.length; ii++) {
        var msg = posts[ii];
        if (msg.matches(filter)) {
            html.push(msg.render());
        }
    }
    if (posts.length && !html.length) {
        html.push('<div class="error">No stuff found for your query, <b>'+htmlescape(filter)+'</b>.</div>');
    }

    $('.posts').each(function(){ this.innerHTML = html.join('') });
}
posts_channel.on_change(display_posts);


/* interface to search UI */

var search_channel = new Channel();
search_channel.on_change(display_posts);

var search_to;
function init_search() {
    if (!search_to) {
        search_to = setTimeout(function() { search_to = undefined; search_channel.changed() }, 0);
    }
}

function update_logged_in_status() {
    if (FB.Connect.get_loggedInUser() !== null) {
        $('.show_only_when_logged_in').show();
    }
}


/* initialization */

update_posts();

$(function(){ $('.search').keyup(init_search).change(init_search) });

var knx_fb_api_key = "2a2806da8abe66693e14bbbcbe9c0c64"; // when I use app id '120935017919365' instead, status messages don't work

function onConnected() { output(["connected", FB.Connect.get_loggedInUser()]); update_logged_in_status() }
function onNotConnected() { output("notconnected"); update_logged_in_status() }

$(function () {
  FB.init(knx_fb_api_key, "/xd_receiver.html", {"ifUserConnected" : onConnected, "ifUserNotConnected": onNotConnected});
});


/* analytics */

function gaSSDSLoad (acct) {
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www."),
      s;
  s = document.createElement('script');
  s.src = gaJsHost + 'google-analytics.com/ga.js';
  s.type = 'text/javascript';
  s.onloadDone = false;
  function init () {
    pageTracker = _gat._getTracker(acct);
    pageTracker._trackPageview();
  }
  s.onload = function () {
    s.onloadDone = true;
    init();
  };
  s.onreadystatechange = function() {
    if (('loaded' === s.readyState || 'complete' === s.readyState) && !s.onloadDone) {
      s.onloadDone = true;
      init();
    }
  };
  document.getElementsByTagName('head')[0].appendChild(s);
}

$(window).load(function() {
    gaSSDSLoad("UA-11388042-1");
});


/* user support */

var uservoiceOptions = {
  /* required */
  key: 'angstro',
  host: 'angstro.uservoice.com', 
  forum: '16688',
  showTab: true,  
  /* optional */
  alignment: 'right',
  background_color:'#444444', 
  text_color: 'white',
  hover_color: '#000000',
  lang: 'en'
};

function _loadUserVoice() {
  var s = document.createElement('script');
  s.setAttribute('type', 'text/javascript');
  s.setAttribute('src', ("https:" == document.location.protocol ? "https://" : "http://") + "cdn.uservoice.com/javascripts/widgets/tab.js");
  document.getElementsByTagName('head')[0].appendChild(s);
}
$(_loadUserVoice);
</script>

</body>
</html>
