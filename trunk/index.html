<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://www.facebook.com/2008/fbml">
<head><title>Search My Stuff on Facebook</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style>
textarea { display: block }
.devtools { display: none }
.searchline { display: none; padding: 2em; }
.login {
    display: inline-block;
    text-align: center;
    font-size: 2em;
    background-color: #eee;
    border: .5em outset;
    border-radius: 6px;
    -moz-border-radius: 6px;
    -webkit-border-radius: 6px;
    padding: 1em;
}
</style>
<style>
/* from Facebook */
body {
color:#333333;
direction:ltr;
font-family:"lucida grande",tahoma,verdana,arial,sans-serif;
font-size:11px;
text-align:left;
}
.uiStreamMessage {
font-size:13px;
font-weight:normal;
margin: 0.5em 0 5px 0;
clear: left;
}
.uiStreamMessage, .uiAttachmentTitle, .uiAttachmentDesc {
word-wrap:break-word;
}
h1, h2, h3, h4, h5, h6 {
color:#333333;
font-size:13px;
margin:0;
padding:0;
}
.uiStreamMessage .actorName, .uiStreamMessage .passiveName {
font-weight:bold;
}
a {
color:#3B5998;
cursor:pointer;
outline-style:none;
text-decoration:none;
}
abbr {
border-bottom:medium none;
}
uiAttachmentDesc, .uiStreamPassive, .uiStreamSource, .uiStreamSource a {
color:#808080;
}
a {
color:#3B5998;
cursor:pointer;
text-decoration:none;
}
.uiStreamSource {
display: block;
margin-top: -0.25em;
margin-bottom: 0.50em;
}
.error {
color: red;
margin: 1em;
font-size: 15px;
}

.UIIntentionalStory_Message {
    font-size: 13px;
    font-weight: normal;
}
.UIIntentionalStory_Names {
    font-weight: bold;
}
.UIStoryAttachment {
    margin: 6px 0 5px;
}
.UIStoryAttachment_Media {
    float: left;
    padding-right: 10px;
}
.UIStoryAttachment_Title {
    font-weight: bold;
}
.UIStoryAttachment_Caption, .UIStoryAttachment_Copy {
    color: #808080;
    padding-top: 3px;
}
img {
    border: 0 none;
}
</style>

</head> <body>

<div style="text-align: center;">
<h1>Search My Stuff on Facebook</h1>
<p>
Click the button below to grab all the stuff you've ever posted on
Facebook. It's just all of your past Facebook statuses and shared
links so far. It will download a backup copy of your Stuff and let you Search
it too.
</p>
<a class="login"
   href="javascript:FB.Connect.requireSession(retrieve_everything)">
     <img src="http://knx.to/i/trefoil_8bit.png" style="vertical-align: middle;" />
     Get My Stuff!
</a>
<br>
<div class="searchline">
  Search: <input class="search" size="64" />
</div>
<div>
<a href="javascript:FB.Connect.logoutAndRedirect(location.href);">log out</a>
| <a href="javascript:export_storage()">json export in popup</a>
| <a href="javascript:reset_storage()">delete local backup</a>
<span>| <a href="#" onclick="$('.devtools').show();$(this).parent().hide(); return false">show dev tools</a></span>
</div>
</div>

<div class="devtools">
<a href="javascript:login()">log in to FB!</a>
| <a href="javascript:FB.Connect.requireSession(retrieve_status)">retrieve status messages</a>
| <a href="javascript:FB.Connect.requireSession(retrieve_link)">retrieve links</a>
| <a href="javascript:display_posts()">display status messages</a>
  <textarea id="FQL" rows=3 cols=80>SELECT time, message, status_id from status where uid=1173721181</textarea>
  <button onclick="do_query()">run query Â»</button>
  <textarea id="output" rows=20 cols=80></textarea>
</div>
<p>
<hr />
<div class="posts"></div>
<div class="fql_link"></div>

<script src="http://static.ak.connect.facebook.com/js/api_lib/v0.4/FeatureLoader.js.php/en_US" type="text/javascript"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.js"></script>
<script src="json2.js"></script>
<script src="local_storage.js"></script>
<script src="karnak.js"></script>
<script src="channel.js"></script>
<script type="text/javascript">


/* developer tools */

function login() {
  FB.ensureInit( function () {
    FB.Connect.requireSession(function () { 
      output("got a session");
    }, false);
  });
}

function do_query() {
    var o = $('#output');
    var q = $('#FQL').val();
    o.val(o.val() + "\n>>> " + q);
    FB.Facebook.apiClient.fql_query(q, output);
}

function output(response) {
    $('#output').val($('#output').val() + "\n" + JSON.stringify(response, undefined, 3));
    if (typeof console != 'undefined') console.log(response);
}


/* replication of FQL tables */

var replicas = {
  _channels: {}
  ,get: function(key) {
        var k = 'fql_' + key;

        if (window[k]) return window[k];

        var string = get_local_storage().get(k);
        if (string) {
            window[k] = JSON.parse(string);
            return window[k];
        }

        return undefined;
    }

  ,set: function(key, value) {
        var k = 'fql_' + key;

        window[k] = value;

        get_local_storage().set(k, JSON.stringify(value, undefined, 3));
        output(['stored', k, value.length]);

        this.channel(key).changed();
    }

  ,remove: function(key) {
        var k = 'fql_' + key;

        output(['deleting', k]);
        get_local_storage().remove(k);
        output(['gone from local storage', k]);

        window[k] = undefined;  // Can't use `delete`, because in IE, "Object does not support this action"
        output(['gone from window', k]);

        this.channel(key).changed();
        output(['notified of change', k]);
    }

  ,channel: function(key) {
        if (!(key in this._channels)) this._channels[key] = new Channel();
        return this._channels[key];
    }
};


/* stuff related to posts in the abstract */

function query_match(query, string) {
    if (query === '') return true;
    if (string === null) return false;
    return -1 !== string.toLowerCase().indexOf(query);
}

function displayDate(unix_epoch) {
  var d = new Date(unix_epoch*1000);
  var t = new Date();
  var s = '';
  var age = t.getTime() - d.getTime();
  var age_d = Math.floor(age / (24*60*60*1000));
  var age_w = Math.floor(age / (7*24*60*60*1000));
  var age_y = t.getYear() - d.getYear();
  var age_m = t.getMonth() - d.getMonth() + 12 * age_y;
  if (age < 1000) {
        s += ("right now");
  } else if ((age >= 1000) && (age < 60*1000)) {
        s += (Math.floor(age/1000) + " second");
        if (age >= 2000) {s += ('s');}
        s += (' ago');
  } else if ((age >= 60*1000) && (age < 60*60*1000)) {
        s += (Math.floor(age/(60*1000)) + " minute");
        if (age >= 2*60*1000) {s += ('s');}
        s += (' ago');
  } else if ((age >= 60*60*1000) && (age < 24*60*60*1000)) {
        s += (Math.floor(age/(60*60*1000)) + " hour");
        if (age >= 2*60*60*1000) {s += ('s');}
        s += (' ago');
  } else if ((age >= 24*60*60*1000) && (age < 7*24*60*60*1000)) {
        s += ((age_d >= 2) ? age_d + " days ago" : "yesterday");
  } else if ((age >= 7*24*60*60*1000) && (age < 4*7*24*60*60*1000)) {
        s += ((age_w >= 2) ? age_w + " weeks ago" : "last week");
  } else if ((age >= 4*7*24*60*60*1000) && (age_y == 0)) {
        s += ((age_m >= 2) ? age_m + " months ago" : "last month");
  } else if (age_y > 0) {
        s += ((age_y >= 2) ? age_y + " years ago" : "last year");
  }
  return s;
}

function autolinkify(text) {
    return (''+text).replace(/http:\/\/[^\s<>"]*[^\s<>".,]/g,
                             '<a href="$&" target="_blank">$&</a>');
}

function autolinkify_var(v) {
    return {render:function(vars) { return autolinkify(htmlescape(vars[v])) }};
}                  

var relative_time_template = {render:function(vars){return displayDate(vars.time_t())}};
var time_template = {render:function(vars){return ''+new Date(1000*vars.time_t())}};

var username_template = {render: function() {
        var users = replicas.get('user') || [{name: 'You'}];
        return htmlescape(users[0].name);
    }
};


/* status posts */

function retrieve_status() {
    var query = 'SELECT uid, time, message, status_id from status where uid=' + 
            FB.Connect.get_loggedInUser();
    FB.Facebook.apiClient.fql_query(query, store_status);
}

function store_status(new_status_messages) {
    if (!new_status_messages) return;
    replicas.set('status', new_status_messages);
}

var status_template = tmpl.as_template([
    '<h6 class="uiStreamMessage">',
    '<a href="http://www.facebook.com/profile.php?id=',tmpl.v('uid'),'" class="actorName">',username_template,'</a> ',
    autolinkify_var('message'),
    '</h6>',
    '<span class="uiStreamSource">',
    '<a href="http://www.facebook.com/profile.php?id=',tmpl.v('uid'),'&amp;v=wall&amp;story_fbid=',tmpl.v('status_id'),'">',
    '<abbr title="',time_template,'" class="timestamp">',relative_time_template,'</abbr></a></span>'
]);

function FQL_Status(obj) {
    $.extend(this, obj);
}
FQL_Status.prototype.render = function() {
    return status_template.render(this);
};
FQL_Status.prototype.time_t = function() { return this.time };
FQL_Status.prototype.matches = function(string) {
    return query_match(string, this.message);
};


/* link posts */

function retrieve_link() {
    var query = 'select link_id,owner,owner_comment,created_time,title,summary,url,image_urls from link where owner = ' +
        FB.Connect.get_loggedInUser();
    FB.Facebook.apiClient.fql_query(query, store_link);
}

function store_link(response) {
    if (!response) return;
    replicas.set('link', response);
}

var link_image_template = {render: function(vars) {
        if (!vars.image_urls) return '';
        if (!vars.image_urls[0]) return '';
        return '<img src="'+htmlescape(vars.image_urls[0])+'" style="float: left; clear: left; margin-right: 0.5em; max-width: 130px; max-height: 130px" />';
    }};

var link_template = tmpl.as_template([
    '<h6 class="uiStreamMessage">',
    link_image_template,
    '<a href="', tmpl.v('url'), '" class="actorName">',tmpl.v('title'),'</a> ',
    autolinkify_var('owner_comment'),
    '</h6>',
    '<span class="uiStreamSource">',
    '<a href="http://www.facebook.com/profile.php?id=',tmpl.v('uid'),'&amp;v=wall&amp;story_fbid=',tmpl.v('link_id'),'">',
    '<abbr title="',time_template,'" class="timestamp">',relative_time_template,'</abbr></a></span>'
]);

function FQL_Link(obj) {
    $.extend(this, obj);
}
FQL_Link.prototype.render = function() {
    return link_template.render(this);
};
FQL_Link.prototype.time_t = function() { return this.created_time };
FQL_Link.prototype.matches = function(query) {
    return (query_match(query, this.owner_comment) ||
            query_match(query, this.title) ||
            query_match(query, this.summary) ||
            query_match(query, this.url));
};


/* user, i.e. myself */

function retrieve_user() {
    var query = 'select uid, username, name from user where uid = ' + 
        FB.Connect.get_loggedInUser();
    FB.Facebook.apiClient.fql_query(query, store_user);
}

function store_user(user) {
    if (!user) return;
    replicas.set('user', user);
}


/* misc. UI functionality */

function retrieve_everything() {
    retrieve_user();
    retrieve_status();
    retrieve_link();
}

function reset_storage () {
    replicas.remove('user');
    replicas.remove('status');
    replicas.remove('link');
}

function export_storage () {
    var g = {
      status: replicas.get('status')
      ,link: replicas.get('link')
      ,user: replicas.get('user')
    };

    var popup = window.open('#', '_blank');
    popup.document.open('text/plain');
    popup.document.write(JSON.stringify(g, undefined, 3));
    popup.document.close();
}


/* the collection of all posts */

var posts = [];
var posts_channel = new Channel();

function update_posts() {
    posts = [];

    var status = replicas.get('status') || [];
    for (var ii = 0; ii < status.length; ii++) {
        posts.push(new FQL_Status(status[ii]));
    }

    var link = replicas.get('link') || [];
    for (var ii = 0; ii < link.length; ii++) {
        posts.push(new FQL_Link(link[ii]));
    }

    posts.sort(function(a, b) {
            return b.time_t() - a.time_t();
    });
    posts_channel.changed();
}

replicas.channel('status').on_change(update_posts);
replicas.channel('link').on_change(update_posts);
replicas.channel('user').on_change(update_posts); // because it's used in some templates.

posts_channel.on_change(function() {
    if (posts.length) {
        $('.searchline').show();
    } else {
        $('.searchline').hide();
    }
});

function display_posts() {
    var filter = $('.search').val();

    var html = [];
    for (var ii = 0; ii < posts.length; ii++) {
        var msg = posts[ii];
        if (msg.matches(filter)) {
            html.push(msg.render());
        }
    }
    if (!html.length) {
        html.push('<div class="error">No status messages found.</div>');
    }

    $('.posts').each(function(){ this.innerHTML = html.join('') });
}
posts_channel.on_change(display_posts);


/* interface to search UI */

var search_channel = new Channel();
search_channel.on_change(display_posts);

var search_to;
function init_search() {
    if (!search_to) {
        search_to = setTimeout(function() { search_to = undefined; search_channel.changed() }, 0);
    }
}


/* initialization */

update_posts();

$(function(){ $('.search').keyup(init_search).change(init_search) });

var knx_fb_api_key = "2a2806da8abe66693e14bbbcbe9c0c64"; // when I use app id '120935017919365' instead, status messages don't work

function onConnected() { output(["connected", FB.Connect.get_loggedInUser()]) }
function onNotConnected() { output("notconnected") }

$(function () {
  FB.init(knx_fb_api_key, "/xd_receiver.html", {"ifUserConnected" : onConnected, "ifUserNotConnected": onNotConnected});
});

</script>
<!--
<div class="UIIntentionalStory_Header"><h3 data-ft='{"type":"msg"}' class="UIIntentionalStory_Message">
                <span data-ft='{"type":"name"}' class="UIIntentionalStory_Names"><a href="http://www.facebook.com/kragen">Kragen Javier Sitaker</a>
                </span><span class="UIStory_Message">I wrote this article early last year, and unfortunately I didn't notice that someone had translated it into Indonesian until just now. This is awesome!<br/><br/><a target="_blank" rel="nofollow" onmousedown='UntrustedLink.bootstrap($(this), "a1a29", event);' href="http://www.pasadon.com/2009/04/bagaimana-kabar-burung-dapat-menyebabkan-kematian/"><span>http://www.pasadon.com/2009/04/bagaimana</span><wbr/><span class="word_break"/><span>-kabar-burung-dapat-menyebabkan-kematian</span><wbr/><span class="word_break"/>/</a></span></h3></div>
<div id="" data-ft='{"type":"attach"}' class="UIStoryAttachment"><div data-ft='{"type":"media"}' class="UIStoryAttachment_Media UIStoryAttachment_MediaSingle"><div class="UIMediaItem"><a rel="nofollow" onmousedown='UntrustedLink.bootstrap($(this), "a1a29", event);' style="" target="_blank" title="" id="" href="http://www.pasadon.com/2009/04/bagaimana-kabar-burung-dapat-menyebabkan-kematian/#comment-1533"><div class="UIMediaItem_Wrapper"><img src="http://external.ak.fbcdn.net/safe_image.php?d=9fa91ea76d3c698d3799e2687d4c27db&amp;w=130&amp;h=130&amp;url=http%3A%2F%2Fcanonical.org%2F%7Ekragen%2FTuskeegee_study_small.jpg" class="img"/></div></a></div></div><div class="UIStoryAttachment_Info"><div class="UIStoryAttachment_Title"><a rel="nofollow" onmousedown='UntrustedLink.bootstrap($(this), "a1a29", event);' style="" target="_blank" id="" href="http://www.pasadon.com/2009/04/bagaimana-kabar-burung-dapat-menyebabkan-kematian/#comment-1533">Bagaimana kabar burung dapat menyebabkan kematian | Pasadon</a></div><div class="UIStoryAttachment_Caption">www.pasadon.com</div><div class="UIStoryAttachment_Copy">Posting ini diterjemahkan secara bebas dari How False Rumors Can Cost Lives oleh Kragen. Saya pikir posting ini perlu dibaca oleh sebanyak mungkin orang, sehingga saya putuskan untuk menterjemahkannya  ...</div></div></div>
-->


</body>
</html>
