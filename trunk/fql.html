<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://www.facebook.com/2008/fbml">
<head><title>FQL Disconnect</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style>
textarea { display: block }
.devtools { display: none }
</style>

<style>
/* from Facebook */
body {
color:#333333;
direction:ltr;
font-family:"lucida grande",tahoma,verdana,arial,sans-serif;
font-size:11px;
text-align:left;
}
.uiStreamMessage {
font-size:13px;
font-weight:normal;
margin:0 0 5px;
}
.uiStreamMessage, .uiAttachmentTitle, .uiAttachmentDesc {
word-wrap:break-word;
}
h1, h2, h3, h4, h5, h6 {
color:#333333;
font-size:13px;
margin:0;
padding:0;
}
.uiStreamMessage .actorName, .uiStreamMessage .passiveName {
font-weight:bold;
}
a {
color:#3B5998;
cursor:pointer;
outline-style:none;
text-decoration:none;
}
abbr {
border-bottom:medium none;
}
uiAttachmentDesc, .uiStreamPassive, .uiStreamSource, .uiStreamSource a {
color:#808080;
}
a {
color:#3B5998;
cursor:pointer;
text-decoration:none;
}
.uiStreamSource {
display: block;
margin-top: -0.25em;
margin-bottom: 0.50em;
}
.error {
color: red;
margin: 1em;
font-size: 15px;
}
</style>

</head> <body>
<a href="javascript:login()">log in to FB!</a>
| <a href="javascript:FB.Connect.logoutAndRedirect(location.href);">log out!</a>
| <a href="javascript:FB.Connect.requireSession(retrieve_status_messages)">retrieve status messages</a>
| <a href="javascript:display_status_messages()">display status messages</a>
| <a href="javascript:export_storage()">json export in popup</a>
| <a href="javascript:reset_storage()">erase all stored information</a>
<span>| <a href="#" onclick="$('.devtools').show();$(this).parent().hide()">show dev tools</a></span>
<div class="devtools">
  <textarea id="FQL" rows=3 cols=80>SELECT time, message, status_id from status where uid=1173721181</textarea>
  <button onclick="do_query()">run query Â»</button>
  <textarea id="output" rows=20 cols=80></textarea>
</div>
<div class="status_messages"></div>
<script src="http://static.ak.connect.facebook.com/js/api_lib/v0.4/FeatureLoader.js.php/en_US" type="text/javascript"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script src="/jquery.json-2.2.min.js"></script>
<script src="local_storage.js"></script>
<script src="karnak.js"></script>
<script type="text/javascript">

var knx_fb_api_key = "2a2806da8abe66693e14bbbcbe9c0c64";

function onConnected() { output(["connected", FB.Connect.get_loggedInUser()]) }
function onNotConnected() { output("notconnected") }

$(function () {
  FB.init(knx_fb_api_key, "/xd_receiver.html", {"ifUserConnected" : onConnected, "ifUserNotConnected": onNotConnected});
  display_status_messages();
});

function login() {
  FB.ensureInit( function () {
    FB.Connect.requireSession(function () { 
      output("got a session");
    }, false);
  });
}

function do_query() {
    var o = $('#output');
    var q = $('#FQL').val();
    o.val(o.val() + "\n>>> " + q);
    FB.Facebook.apiClient.fql_query(q, output);
}

function output(response) {
    $('#output').val($('#output').val() + "\n" + $.toJSON(response));
    if (typeof console != 'undefined') console.log(response);
}

var status_messages;

function retrieve_status_messages() {
    var query = 'SELECT uid, time, message, status_id from status where uid=' + 
            FB.Connect.get_loggedInUser();
    FB.Facebook.apiClient.fql_query(query, function (response) {store_status_messages(response); display_status_messages(); });
}

function store_status_messages(new_status_messages) {
    if (!new_status_messages) return;
    status_messages = new_status_messages;
    get_local_storage().set('status_messages', $.toJSON(status_messages));
    output(["stored status_messages:", status_messages.length]);
}

function displayDate(unix_epoch) {
  var d = new Date(unix_epoch*1000);
  var t = new Date();
  var s = '';
  var age = t.getTime() - d.getTime();
  var age_d = Math.floor(age / (24*60*60*1000));
  var age_w = Math.floor(age / (7*24*60*60*1000));
  var age_y = t.getYear() - d.getYear();
  var age_m = t.getMonth() - d.getMonth() + 12 * age_y;
  if (age < 1000) {
        s += ("right now");
  } else if ((age >= 1000) && (age < 60*1000)) {
        s += (Math.floor(age/1000) + " second");
        if (age >= 2000) {s += ('s');}
        s += (' ago');
  } else if ((age >= 60*1000) && (age < 60*60*1000)) {
        s += (Math.floor(age/(60*1000)) + " minute");
        if (age >= 2*60*1000) {s += ('s');}
        s += (' ago');
  } else if ((age >= 60*60*1000) && (age < 24*60*60*1000)) {
        s += (Math.floor(age/(60*60*1000)) + " hour");
        if (age >= 2*60*60*1000) {s += ('s');}
        s += (' ago');
  } else if ((age >= 24*60*60*1000) && (age < 7*24*60*60*1000)) {
        s += ((age_d >= 2) ? age_d + " days ago" : "yesterday");
  } else if ((age >= 7*24*60*60*1000) && (age < 4*7*24*60*60*1000)) {
        s += ((age_w >= 2) ? age_w + " weeks ago" : "last week");
  } else if ((age >= 4*7*24*60*60*1000) && (age_y == 0)) {
        s += ((age_m >= 2) ? age_m + " months ago" : "last month");
  } else if (age_y > 0) {
        s += ((age_y >= 2) ? age_y + " years ago" : "last year");
  }
  return s;
}

function autolinkify(text) {
    return (''+text).replace(/http:\/\/[^\s<>"]*[^\s<>".,]/g,
                             '<a href="$&" target="_blank">$&</a>');
}

function autolinkify_var(v) {
    return {render:function(vars) { return autolinkify(htmlescape(vars[v])) }};
}                  

var relative_time_template = {render:function(vars){return displayDate(vars.time)}};
var time_template = {render:function(vars){return ''+new Date(1000*vars.time)}};

var status_template = tmpl.as_template([
    '<h6 class="uiStreamMessage">',
    '<a href="http://www.facebook.com/profile.php?id=',tmpl.v('uid'),'" class="actorName">','You','</a> ',
    autolinkify_var('message'),
    '</h6>',
    '<span class="uiStreamSource">',
    '<a href="http://www.facebook.com/profile.php?id=',tmpl.v('uid'),'&amp;v=wall&amp;story_fbid=',tmpl.v('status_id'),'">',
    '<abbr title="',time_template,'" class="timestamp">',relative_time_template,'</abbr></a></span>'
]);

function render_status_message(message) {
    return status_template.render(message);
}

function display_status_messages() {
    if (!status_messages) {
        var g = get_local_storage().get('status_messages');
        if (g && g.length) {
            status_messages = $.evalJSON(g);
        }
    }
    if (!status_messages) {
        $('.status_messages').html('<div class="error">No status messages are available right now.</div>');
        return;
    }
    var html = [];
    for (var ii = 0; ii < status_messages.length; ii++) {
        html.push(render_status_message(status_messages[ii]));
    }
    $('.status_messages').html(html.join(''));                          
}

function reset_storage () {
    get_local_storage().remove('status_messages')
    if (status_messages) { status_messages = null; }
    display_status_messages();
}

function export_storage () {
    var g = get_local_storage().get('status_messages');
    if (g && g.length) {
        var popup = window.open('#', '_blank');
        popup.document.open('text/plain');
        popup.document.write(g.replace(/\}\,\{/g , '},\n{')); 
        popup.document.close();
    }
}

</script>
</body>
</html>
