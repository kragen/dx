<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://www.facebook.com/2008/fbml">
<head><title>FQL Disconnect</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style>
textarea { display: block }
.devtools { display: none }
.searchline { display: none }
</style>

<style>
/* from Facebook */
body {
color:#333333;
direction:ltr;
font-family:"lucida grande",tahoma,verdana,arial,sans-serif;
font-size:11px;
text-align:left;
}
.uiStreamMessage {
font-size:13px;
font-weight:normal;
margin: 0.5em 0 5px 0;
clear: left;
}
.uiStreamMessage, .uiAttachmentTitle, .uiAttachmentDesc {
word-wrap:break-word;
}
h1, h2, h3, h4, h5, h6 {
color:#333333;
font-size:13px;
margin:0;
padding:0;
}
.uiStreamMessage .actorName, .uiStreamMessage .passiveName {
font-weight:bold;
}
a {
color:#3B5998;
cursor:pointer;
outline-style:none;
text-decoration:none;
}
abbr {
border-bottom:medium none;
}
uiAttachmentDesc, .uiStreamPassive, .uiStreamSource, .uiStreamSource a {
color:#808080;
}
a {
color:#3B5998;
cursor:pointer;
text-decoration:none;
}
.uiStreamSource {
display: block;
margin-top: -0.25em;
margin-bottom: 0.50em;
}
.error {
color: red;
margin: 1em;
font-size: 15px;
}
</style>

</head> <body>
<a href="javascript:FB.Connect.requireSession(retrieve_everything)">Download all your past Facebook links and statuses</a>
| <a href="javascript:FB.Connect.logoutAndRedirect(location.href);">log out!</a>
| <a href="javascript:export_storage()">json export in popup</a>
| <a href="javascript:reset_storage()">delete local backup</a>
<span>| <a href="#" onclick="$('.devtools').show();$(this).parent().hide(); return false">show dev tools</a></span>
<div class="devtools">
<a href="javascript:login()">log in to FB!</a>
| <a href="javascript:FB.Connect.requireSession(retrieve_status_messages)">retrieve status messages</a>
| <a href="javascript:FB.Connect.requireSession(retrieve_link)">retrieve links</a>
| <a href="javascript:display_posts()">display status messages</a>
  <textarea id="FQL" rows=3 cols=80>SELECT time, message, status_id from status where uid=1173721181</textarea>
  <button onclick="do_query()">run query Â»</button>
  <textarea id="output" rows=20 cols=80></textarea>
</div>
<div class="searchline">
  Search: <input class="search" size="64" />
</div>
<div class="status_messages"></div>
<div class="fql_link"></div>
<script src="http://static.ak.connect.facebook.com/js/api_lib/v0.4/FeatureLoader.js.php/en_US" type="text/javascript"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.js"></script>
<script src="json2.js"></script>
<script src="local_storage.js"></script>
<script src="karnak.js"></script>
<script src="channel.js"></script>
<script type="text/javascript">

var knx_fb_api_key = "2a2806da8abe66693e14bbbcbe9c0c64";

function onConnected() { output(["connected", FB.Connect.get_loggedInUser()]) }
function onNotConnected() { output("notconnected") }

$(function () {
  FB.init(knx_fb_api_key, "/xd_receiver.html", {"ifUserConnected" : onConnected, "ifUserNotConnected": onNotConnected});
});

function login() {
  FB.ensureInit( function () {
    FB.Connect.requireSession(function () { 
      output("got a session");
    }, false);
  });
}

function do_query() {
    var o = $('#output');
    var q = $('#FQL').val();
    o.val(o.val() + "\n>>> " + q);
    FB.Facebook.apiClient.fql_query(q, output);
}

function output(response) {
    $('#output').val($('#output').val() + "\n" + JSON.stringify(response, undefined, 3));
    if (typeof console != 'undefined') console.log(response);
}


/* replication of FQL tables */
var replicas = {
  _channels: {}
  ,get: function(key) {
        var k = 'fql_' + key;
        if (window[k]) return window[k];
        var string = get_local_storage().get(k);
        if (string) {
            window[k] = JSON.parse(string);
            return window[k];
        }
        return undefined;
    }
  ,set: function(key, value) {
        var k = 'fql_' + key;
        window[k] = value;
        get_local_storage().set(k, JSON.stringify(value, undefined, 3));
        output(['stored', k, value.length]);
        if (key in this._channels) this._channels[key].changed();
    }
  ,on_change: function(key, observer) {
        if (!(key in this._channels)) this._channels[key] = new Channel();
        this._channels[key].on_change(observer);
    }
  ,remove: function(key) {
        var k = 'fql_' + key;
        output(['deleting', k]);
        get_local_storage().remove(k);
        output(['gone from local storage', k]);
        window[k] = undefined;  // Can't use `delete`, because in IE, "Object does not support this action"
        output(['gone from window', k]);
        if (key in this._channels) this._channels[key].changed();
        output(['notified of change', k]);
    }
};


function retrieve_status_messages() {
    var query = 'SELECT uid, time, message, status_id from status where uid=' + 
            FB.Connect.get_loggedInUser();
    FB.Facebook.apiClient.fql_query(query, store_status_messages);
}

function store_status_messages(new_status_messages) {
    if (!new_status_messages) return;
    replicas.set('status', new_status_messages);
}

function displayDate(unix_epoch) {
  var d = new Date(unix_epoch*1000);
  var t = new Date();
  var s = '';
  var age = t.getTime() - d.getTime();
  var age_d = Math.floor(age / (24*60*60*1000));
  var age_w = Math.floor(age / (7*24*60*60*1000));
  var age_y = t.getYear() - d.getYear();
  var age_m = t.getMonth() - d.getMonth() + 12 * age_y;
  if (age < 1000) {
        s += ("right now");
  } else if ((age >= 1000) && (age < 60*1000)) {
        s += (Math.floor(age/1000) + " second");
        if (age >= 2000) {s += ('s');}
        s += (' ago');
  } else if ((age >= 60*1000) && (age < 60*60*1000)) {
        s += (Math.floor(age/(60*1000)) + " minute");
        if (age >= 2*60*1000) {s += ('s');}
        s += (' ago');
  } else if ((age >= 60*60*1000) && (age < 24*60*60*1000)) {
        s += (Math.floor(age/(60*60*1000)) + " hour");
        if (age >= 2*60*60*1000) {s += ('s');}
        s += (' ago');
  } else if ((age >= 24*60*60*1000) && (age < 7*24*60*60*1000)) {
        s += ((age_d >= 2) ? age_d + " days ago" : "yesterday");
  } else if ((age >= 7*24*60*60*1000) && (age < 4*7*24*60*60*1000)) {
        s += ((age_w >= 2) ? age_w + " weeks ago" : "last week");
  } else if ((age >= 4*7*24*60*60*1000) && (age_y == 0)) {
        s += ((age_m >= 2) ? age_m + " months ago" : "last month");
  } else if (age_y > 0) {
        s += ((age_y >= 2) ? age_y + " years ago" : "last year");
  }
  return s;
}

function autolinkify(text) {
    return (''+text).replace(/http:\/\/[^\s<>"]*[^\s<>".,]/g,
                             '<a href="$&" target="_blank">$&</a>');
}

function autolinkify_var(v) {
    return {render:function(vars) { return autolinkify(htmlescape(vars[v])) }};
}                  

var relative_time_template = {render:function(vars){return displayDate(vars.time_t())}};
var time_template = {render:function(vars){return ''+new Date(1000*vars.time_t())}};

var status_template = tmpl.as_template([
    '<h6 class="uiStreamMessage">',
    '<a href="http://www.facebook.com/profile.php?id=',tmpl.v('uid'),'" class="actorName">','You','</a> ',
    autolinkify_var('message'),
    '</h6>',
    '<span class="uiStreamSource">',
    '<a href="http://www.facebook.com/profile.php?id=',tmpl.v('uid'),'&amp;v=wall&amp;story_fbid=',tmpl.v('status_id'),'">',
    '<abbr title="',time_template,'" class="timestamp">',relative_time_template,'</abbr></a></span>'
]);

function query_match(query, string) {
    if (query === '') return true;
    if (string === null) return false;
    return -1 !== string.toLowerCase().indexOf(query);
}

function FQL_Status(obj) {
    $.extend(this, obj);
}
FQL_Status.prototype.render = function() {
    return status_template.render(this);
};
FQL_Status.prototype.time_t = function() { return this.time };
FQL_Status.prototype.matches = function(string) {
    return query_match(string, this.message);
};


function retrieve_link() {
    var query = 'select link_id,owner,owner_comment,created_time,title,summary,url,image_urls from link where owner = ' +
        FB.Connect.get_loggedInUser();
    FB.Facebook.apiClient.fql_query(query, store_link);
}

function store_link(response) {
    if (!response) return;
    replicas.set('link', response);
}

var link_image_template = {render: function(vars) {
        if (!vars.image_urls) return '';
        if (!vars.image_urls[0]) return '';
        return '<img src="'+htmlescape(vars.image_urls[0])+'" style="float: left; clear: left; margin-right: 0.5em; max-width: 130px; max-height: 130px" />';
    }};

var link_template = tmpl.as_template([
    '<h6 class="uiStreamMessage">',
    link_image_template,
    '<a href="', tmpl.v('url'), '" class="actorName">',tmpl.v('title'),'</a> ',
    autolinkify_var('owner_comment'),
    '</h6>',
    '<span class="uiStreamSource">',
    '<a href="http://www.facebook.com/profile.php?id=',tmpl.v('uid'),'&amp;v=wall&amp;story_fbid=',tmpl.v('link_id'),'">',
    '<abbr title="',time_template,'" class="timestamp">',relative_time_template,'</abbr></a></span>'
]);

function FQL_Link(obj) {
    $.extend(this, obj);
}
FQL_Link.prototype.render = function() {
    return link_template.render(this);
};
FQL_Link.prototype.time_t = function() { return this.created_time };
FQL_Link.prototype.matches = function(query) {
    return (query_match(query, this.owner_comment) ||
            query_match(query, this.title) ||
            query_match(query, this.summary) ||
            query_match(query, this.url));
};


function retrieve_everything() {
    retrieve_status_messages();
    retrieve_link();
}

function reset_storage () {
    replicas.remove('status');
    replicas.remove('link');
}

function export_storage () {
    var g = {
      status: replicas.get('status')
      ,link: replicas.get('link')
    };

    var popup = window.open('#', '_blank');
    popup.document.open('text/plain');
    popup.document.write(JSON.stringify(g, undefined, 3));
    popup.document.close();
}


var posts = [];
var posts_channel = new Channel();

function update_posts() {
    posts = [];

    var status = replicas.get('status') || [];
    for (var ii = 0; ii < status.length; ii++) {
        posts.push(new FQL_Status(status[ii]));
    }

    var link = replicas.get('link') || [];
    for (var ii = 0; ii < link.length; ii++) {
        posts.push(new FQL_Link(link[ii]));
    }

    posts.sort(function(a, b) {
            return b.time_t() - a.time_t();
    });
    posts_channel.changed();
}

replicas.on_change('status', update_posts);
replicas.on_change('link', update_posts);

posts_channel.on_change(function() {
    if (posts.length) {
        $('.searchline').show();
    } else {
        $('.searchline').hide();
    }
});

update_posts();

function display_posts() {
    var filter = $('.search').val();

    var html = [];
    for (var ii = 0; ii < posts.length; ii++) {
        var msg = posts[ii];
        if (msg.matches(filter)) {
            html.push(msg.render());
        }
    }
    if (!html.length) {
        html.push('<div class="error">No status messages found.</div>');
    }

    $('.status_messages').each(function(){ this.innerHTML = html.join('') });
}
posts_channel.on_change(display_posts);


var search_channel = new Channel();
search_channel.on_change(display_posts);

var search_to;
function init_search() {
    if (!search_to) {
        search_to = setTimeout(function() { search_to = undefined; search_channel.changed() }, 0);
    }
}

$(function(){ $('.search').keyup(init_search).change(init_search) });

</script>
</body>
</html>
